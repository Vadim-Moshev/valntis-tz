<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/style.css" />
    <title>Тестовое задание для Валантис</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
    <script src="scripts/api.js" defer></script>
    <script src="scripts/dom_api.js" defer></script>
    <script type="module">
      const LIMIT = 50;

      const parseSearchParams = () => {
        const search = location.search.substring(1);
        const pairs = search.split("&");
        const obj = {};

        pairs.forEach((item) => {
          const [key, value] = item.split("=");
          obj[key] = value;
        });

        return obj;
      };

      const searchParams = parseSearchParams();
      const offset = Number(searchParams.offset || 0);

      const state = {
        offset,
      };

      buttonPrev.onclick = () => {
        const offset = state.offset;

        if (state.offset === 0) {
          location = `index.html?offset=${offset}`;
          return;
        }

        location = `index.html?offset=${offset - LIMIT}`;
      };

      buttonNext.onclick = () => {
        const offset = state.offset;
        location = `index.html?offset=${offset + LIMIT}`;
      };

      const post = async (body) => {
        const options = {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify(body),
        };

        return await fetch(API_URL, options);
      };

      const getIDs = async (offset, limit) => {
        const params = { offset, limit };
        const body = {
          action: "get_ids",
          params,
        };

        const response = await post(body);
        const result = response.json();

        return result;
      };

      const getItems = async (setOfProductsIds) => {
        const params = { ids: Array.from(setOfProductsIds) };
        const body = {
          action: "get_items",
          params,
        };

        const response = await post(body);
        const result = response.json();

        return result;
      };

      loader.classList.add('loader-visible');
      const responseIds = await getIDs(state.offset, LIMIT);
      const setOfProductsIds = new Set(responseIds.result);

      const responseProducts = await getItems(setOfProductsIds);
      const arrayOfProducts = responseProducts.result;
      loader.classList.remove('loader-visible');


      if (setOfProductsIds.size > 0) {
        const productsList = createProductsList(arrayOfProducts);

        document.body.appendChild(productsList);
      }
    </script>
  </head>
  <body>
    <div>
      <input type="button" value="Назад" id="buttonPrev" />
      <input type="button" value="Вперёд" id="buttonNext" />
    </div>
    <img class="loader" id="loader" src="img/loader.gif" alt="" />
  </body>
</html>
